; ============================================
; MAGNUS PBX - PJSIP Configuration
; Asterisk 22.8.2 Multi-tenant Realtime
; ============================================

[global]
type=global
user_agent=Magnus-PBX-Asterisk22
max_forwards=70
keep_alive_interval=90
contact_expiration_check_interval=30
; Necessário para multi-tenant por domínio (ramal@slug)
disable_multi_domain=no
; CRÍTICO para multi-tenant: username usa ps_domain_aliases para resolver ramal@slug
; Ordem recomendada SaaS: 1) auth_username (AuthID único) → 2) username+domínio → 3) ip → 4) anon
endpoint_identifier_order=auth_username,username,ip,anonymous

; ============================================
; SYSTEM CONFIGURATION
; ============================================
[system]
type=system
; Ajuste de memória para PJSIP Realtime com 1.000+ tenants
timer_t1=500
timer_b=32000
threadpool_initial_size=10
threadpool_auto_increment=5
threadpool_idle_timeout=60
threadpool_max_size=50
disable_tcp_switch=yes

; ============================================
; TRANSPORT - UDP (GENÉRICO para Multi-tenant)
; ============================================
; Transport genérico usado por TODOS os tenants.
; SEM campo 'domain' = aceita QUALQUER domínio.
; O matching tenant/domain é feito via ps_domain_aliases (database).
;
; Vantagens para SaaS:
; - Adicione novos tenants sem editar este arquivo
; - Totalmente dinâmico via banco de dados
; - Escalável para centenas de tenants
;
; Como funciona:
; 1. Softphone registra: 1001@belavista.magnussystem.com.br
; 2. Transport aceita (sem restrição)
; 3. ps_domain_aliases.domain_alias mapeia: belavista.magnussystem.com.br → belavista
; 4. Asterisk busca endpoint: 1001@belavista no banco

[transport-udp]
type=transport
protocol=udp
bind=0.0.0.0:5060
; SEM campo 'domain' = aceita todos os domínios (matching via ps_domain_aliases)
; Docker/NAT: anunciar IP acessível pelos telefones (evita contato 172.x interno)
external_signaling_address=10.3.2.253
external_media_address=10.3.2.253
; Marcar apenas a rede interna do container como local.
; Assim clientes da LAN/WAN recebem external_* acima.
local_net=172.20.0.0/16

; ============================================
; REALTIME ENDPOINTS, AUTHS, AORS
; ============================================
; Os endpoints são carregados do banco de dados PostgreSQL.
; Veja sorcery.conf e extconfig.conf para o mapeamento.
;
; Estrutura no banco:
; - ID formato: ramal@slug (ex: 1001@belavista)
; - Context: ctx-slug (ex: ctx-belavista)
; - Transport: transport-udp (definido acima)
;
; Exemplo de registro no banco:
; INSERT INTO ps_endpoints (id, transport, aors, auth, context) VALUES
; ('1001@belavista', 'transport-udp', '1001@belavista', '1001@belavista', 'ctx-belavista');
; ============================================
