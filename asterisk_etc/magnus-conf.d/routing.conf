; ============================================
; MAGNUS PBX - Call Routing
; Sub-rotinas para discagem interna e externa
; ============================================

; ============================================
; SUB-ROTINA: Resolver variaveis de tenant/ramal
; Exporta: FROM_ENDPOINT, TENANT_SLUG, FROM_EXTEN, DIAL_OPTIONS
; ============================================
[sub-tenant-vars]
exten => s,1,NoOp(=== Resolve Tenant Vars ===)
 same => n,Set(__FROM_ENDPOINT=${CHANNEL(endpoint)})
 same => n,Set(__TENANT_SLUG=${CHANNEL(tenantid)})
 same => n,ExecIf($["${TENANT_SLUG}" = ""]?Set(__TENANT_SLUG=${CUT(FROM_ENDPOINT,@,2)}))
 same => n,ExecIf($["${TENANT_SLUG}" = ""]?Set(__TENANT_SLUG=${CUT(FROM_ENDPOINT,_,1)}))
 same => n,Set(__FROM_EXTEN=${CUT(FROM_ENDPOINT,@,1)})
 same => n,ExecIf($["${FROM_ENDPOINT}" = "${FROM_EXTEN}"]?Set(__FROM_EXTEN=${CUT(FROM_ENDPOINT,_,2)}))
 same => n,ExecIf($["${FROM_EXTEN}" = ""]?Set(__FROM_EXTEN=${CALLERID(num)}))
 same => n,Set(__DIAL_OPTIONS=TtKkHhXx)
 same => n,NoOp(Resolved: endpoint=${FROM_ENDPOINT} tenant=${TENANT_SLUG} exten=${FROM_EXTEN})
 same => n,Return()

; ============================================
; SUB-ROTINA: Montar endpoint de destino
; ARG1 = numero/ramal destino
; Retorna GOSUB_RETVAL com endpoint completo
; ============================================
[sub-build-dest-endpoint]
exten => s,1,NoOp(=== Build Destination Endpoint: ${ARG1} ===)
 same => n,Set(GOSUB_RETVAL=${ARG1}@${TENANT_SLUG})
 same => n,ExecIf($["${FROM_ENDPOINT}" = "${CUT(FROM_ENDPOINT,@,1)}"]?Set(GOSUB_RETVAL=${TENANT_SLUG}_${ARG1}))
 same => n,NoOp(Destination endpoint: ${GOSUB_RETVAL})
 same => n,Return()

; ============================================
; SUB-ROTINA: Discagem Interna
; ============================================
[dial-internal]
exten => _X.,1,NoOp(=== Internal Call: ${CALLERID(num)} -> ${EXTEN} ===)
 same => n,Gosub(sub-tenant-vars,s,1)
 same => n,Gosub(sub-build-dest-endpoint,s,1(${EXTEN}))
 same => n,Set(DEST_ENDPOINT=${GOSUB_RETVAL})
 
 same => n,NoOp(TenantID=${CHANNEL(tenantid)} | Route: ${FROM_EXTEN}@${TENANT_SLUG} -> ${DEST_ENDPOINT})
 
 ; Verificar Call Forward
 same => n,Set(CF_TARGET=${DB(CF/${FROM_EXTEN})})
 same => n,GotoIf($["${CF_TARGET}" != ""]?call_forward:normal_call)
 
 same => n(call_forward),NoOp(Forwarded to ${CF_TARGET})
 same => n,Gosub(sub-build-dest-endpoint,s,1(${CF_TARGET}))
 same => n,Set(DEST_ENDPOINT=${GOSUB_RETVAL})
 
 same => n(normal_call),Set(CALLERID(name)=${FROM_EXTEN})
 same => n,Dial(PJSIP/${DEST_ENDPOINT},30,${DIAL_OPTIONS})
 
 ; Tratamento de nao atendimento
 same => n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?voicemail)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
 same => n,GotoIf($["${DIALSTATUS}" = "CHANUNAVAIL"]?unavailable)
 same => n,Hangup()
 
 same => n(voicemail),NoOp(Sending to voicemail - No Answer)
 same => n,VoiceMail(${EXTEN}@${CONTEXT},u)
 same => n,Hangup()
 
 same => n(busy),NoOp(Extension busy)
 same => n,VoiceMail(${EXTEN}@${CONTEXT},b)
 same => n,Hangup()
 
 same => n(unavailable),NoOp(Extension unavailable)
 same => n,Playback(ss-noservice)
 same => n,Hangup()

; ============================================
; SUB-ROTINA: Discagem Externa
; ============================================
[dial-outbound]
exten => _X.,1,NoOp(=== Outbound Call: ${CALLERID(num)} -> ${EXTEN} ===)
 same => n,Gosub(sub-tenant-vars,s,1)
 
 same => n,NoOp(TenantID=${CHANNEL(tenantid)} | External: ${FROM_EXTEN}@${TENANT_SLUG} -> ${EXTEN})
 
 ; Buscar rota de saida via API (retorno texto: trunk|numero_normalizado)
 same => n,Set(API_URL=http://backend:5000/api/agi/get-outbound-route)
 same => n,Set(QUERY=?tenant=${TENANT_SLUG}&number=${EXTEN}&format=text)
 same => n,Set(ROUTE_RESULT=${CURL(${API_URL}${QUERY})})
 same => n,NoOp(Outbound router result: ${ROUTE_RESULT})

 same => n,Set(TRUNK_NAME=${CUT(ROUTE_RESULT,|,1)})
 same => n,Set(OUT_NUMBER=${CUT(ROUTE_RESULT,|,2)})
 same => n,ExecIf($["${OUT_NUMBER}" = ""]?Set(OUT_NUMBER=${EXTEN}))
 same => n,GotoIf($["${TRUNK_NAME}" != ""]?dial_trunk:no_route)
 
 same => n(dial_trunk),Dial(PJSIP/${OUT_NUMBER}@${TRUNK_NAME},60,${DIAL_OPTIONS})
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy:unavail)
 same => n,Hangup()
 
 same => n(busy),Busy(20)
 same => n,Hangup()
 
 same => n(unavail),Playback(all-circuits-busy-now)
 same => n,Hangup()
 
 same => n(no_route),Answer()
 same => n,Playback(ss-noservice)
 same => n,Hangup()

; ============================================
; SUB-ROTINA: Numeros de Emergencia
; ============================================
[dial-emergency]
exten => _X.,1,NoOp(=== Emergency Call: ${EXTEN} ===)
 same => n,Gosub(sub-tenant-vars,s,1)
 same => n,NoOp(TenantID=${CHANNEL(tenantid)} | Emergency tenant=${TENANT_SLUG})
 
 ; Emergencias sempre usam trunk prioritario
 same => n,Set(TRUNK_NAME=trunk-emergency)
 same => n,Dial(PJSIP/${EXTEN}@${TRUNK_NAME},120,${DIAL_OPTIONS})
 
 ; Fallback se trunk nao existir
 same => n,Answer()
 same => n,Playback(cannot-complete-as-dialed)
 same => n,Hangup()

; ============================================
; CONTEXTO: Chamadas Recebidas (DIDs)
; ============================================
[from-trunk]
; Chamadas vindas de trunks SIP externos
exten => _X.,1,NoOp(=== Incoming DID: ${EXTEN} ===)
 same => n,Set(DID=${EXTEN})
 same => n,Set(CHANNEL(language)=pt_BR)
 
 ; Buscar roteamento do DID via API
 same => n,Set(API_URL=http://backend:5000/api/agi/get-did-route)
 same => n,Set(QUERY=?did=${DID})
 same => n,Set(RESPONSE=${CURL(${API_URL}${QUERY})})
 
 ; TODO: Parse JSON e rotear para tenant/extension correto
 ; Exemplo: Goto(ctx-belavista,1000,1)
 
 ; Temporario: IVR generico
 same => n,Answer()
 same => n,Playback(welcome)
 same => n,Hangup()
