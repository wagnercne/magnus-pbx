; ============================================
; MAGNUS PBX - Feature Codes
; Códigos de funcionalidades (*43, *97, etc)
; ============================================

; ============================================
; TEMPLATE BASE COM FEATURES
; ============================================
[features-base](!)
; Template herdado por todos os tenants
; Contém apenas os feature codes

; ===== TESTES E DIAGNÓSTICO =====

; *43 - Echo Test (Teste de Áudio)
exten => *43,1,NoOp(=== Echo Test: ${CALLERID(num)} ===)
 same => n,Answer()
 same => n,Playback(demo-echotest)
 same => n,Echo()
 same => n,Hangup()

; *98 - Status Check
exten => *98,1,NoOp(=== Status Check ===)
 same => n,Answer()
 same => n,Playback(hello-world)
 same => n,SayDigits(${EPOCH})
 same => n,Hangup()

; ===== VOICEMAIL =====

; *97 - VoiceMail Check (Própria caixa postal)
exten => *97,1,NoOp(=== VoiceMail Main: ${CALLERID(num)} ===)
 same => n,Answer()
 same => n,VoiceMailMain(${CALLERID(num)}@${CONTEXT})
 same => n,Hangup()

; *99XXXX - VoiceMail Deposit (Deixar mensagem)
exten => _*99XXXX,1,NoOp(=== VoiceMail Deposit to ${EXTEN:3} ===)
 same => n,Answer()
 same => n,VoiceMail(${EXTEN:3}@${CONTEXT},u)
 same => n,Hangup()

; ===== CALL RECORDING =====

; *65 - Start Recording
exten => *65,1,NoOp(=== Start Call Recording ===)
 same => n,Answer()
 same => n,Set(RECORDING_FILE=/var/spool/asterisk/monitor/${UNIQUEID}.wav)
 same => n,MixMonitor(${RECORDING_FILE})
 same => n,Playback(beep)
 same => n,Hangup()

; *66 - Stop Recording
exten => *66,1,NoOp(=== Stop Call Recording ===)
 same => n,StopMixMonitor()
 same => n,Playback(beep)
 same => n,Hangup()

; ===== CALL FORWARD =====

; *72XXXX - Call Forward Enable
exten => _*72XXXX,1,NoOp(=== Call Forward Enable: ${CALLERID(num)} -> ${EXTEN:3} ===)
 same => n,Answer()
 same => n,Set(FROM_EXTEN=${CALLERID(num)})
 same => n,Set(DB(CF/${FROM_EXTEN})=${EXTEN:3})
 same => n,Playback(call-fwd-on)
 same => n,Hangup()

; *73 - Call Forward Disable
exten => *73,1,NoOp(=== Call Forward Disable: ${CALLERID(num)} ===)
 same => n,Answer()
 same => n,Set(FROM_EXTEN=${CALLERID(num)})
 same => n,DBdel(CF/${FROM_EXTEN})
 same => n,Playback(call-fwd-off)
 same => n,Hangup()

; ===== CONFERENCE =====

; *60XXX - Conference Room
exten => _*60XXX,1,NoOp(=== Conference Room ${EXTEN:3} ===)
 same => n,Answer()
 same => n,Set(CONF_ROOM=${EXTEN:3})
 same => n,ConfBridge(${CONF_ROOM})
 same => n,Hangup()

; ===== PORTARIA VIRTUAL (GATE CONTROL) =====

; *500 - Abrir Portão Social
exten => *500,1,NoOp(=== Gate Open: social ===)
 same => n,Set(GATE_NAME=social)
 same => n,Gosub(open-gate,s,1)

; *501 - Abrir Portão Garagem
exten => *501,1,NoOp(=== Gate Open: garagem ===)
 same => n,Set(GATE_NAME=garagem)
 same => n,Gosub(open-gate,s,1)

; *502 - Abrir Portão Fundos
exten => *502,1,NoOp(=== Gate Open: fundos ===)
 same => n,Set(GATE_NAME=fundos)
 same => n,Gosub(open-gate,s,1)

; ===== CALL PARKING =====

; *70 - Park Call
exten => *70,1,NoOp(=== Park Call ===)
 same => n,Park()
 same => n,Hangup()

; ===== SPY/WHISPER =====

; *333XXXX - Spy on Extension
exten => _*333XXXX,1,NoOp(=== Spy on ${EXTEN:4} ===)
 same => n,Answer()
 same => n,ChanSpy(PJSIP/${EXTEN:4},qW)
 same => n,Hangup()

; *334XXXX - Whisper to Extension
exten => _*334XXXX,1,NoOp(=== Whisper to ${EXTEN:4} ===)
 same => n,Answer()
 same => n,ChanSpy(PJSIP/${EXTEN:4},qw)
 same => n,Hangup()

; ============================================
; SUB-ROTINA: Abrir Portão
; ============================================
[open-gate]
exten => s,1,NoOp(=== Open Gate: ${GATE_NAME} - Caller: ${CALLERID(num)} ===)
 same => n,Set(TENANT_SLUG=${CUT(CHANNEL(endpoint),@,2)})
 
 ; Validar permissão via API
 same => n,Set(API_URL=http://backend:5000/api/agi/check-gate-permission)
 same => n,Set(QUERY=?tenant=${TENANT_SLUG}&extension=${CALLERID(num)}&gate=${GATE_NAME})
 same => n,Set(RESPONSE=${CURL(${API_URL}${QUERY})})
 
 ; Parse JSON response (simplificado - em produção use jq via System)
 same => n,GotoIf($["${RESPONSE:0:1}" = "{"]?check_allowed:api_error)
 
 same => n(check_allowed),NoOp(Checking permission...)
 ; TODO: Parse JSON properly - por enquanto assume allowed=true para teste
 same => n,Set(ALLOWED=1)
 same => n,GotoIf($["${ALLOWED}" = "1"]?open:denied)
 
 same => n(open),Answer()
 same => n,Playback(beep)
 same => n,System(/usr/local/bin/open_gate.sh ${GATE_NAME} ${CALLERID(num)} ${UNIQUEID})
 same => n,Playback(auth-thankyou)
 same => n,Hangup()
 
 same => n(denied),Answer()
 same => n,Playback(access-denied)
 same => n,Hangup()
 
 same => n(api_error),Answer()
 same => n,Playback(an-error-has-occurred)
 same => n,Hangup()
