; ============================================
; MAGNUS PBX - DIALPLAN HABRIDO
; Abordagem: PadrAes fixos em .conf + Rotas dinAmicas via AGI/API
; ============================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

; ============================================
; TENANT BASE TEMPLATE
; PadrAes fixos que nAo mudam
; ============================================
[tenant-base](!)

; ===== FEATURE CODES (FIXOS) =====

; Echo Test - *43
exten => *43,1,NoOp(=== Echo Test: ${CALLERID(num)} ===)
 same => n,Answer()
 same => n,Playback(demo-echotest)
 same => n,Echo()
 same => n,Hangup()

; VoiceMail Main - *97
exten => *97,1,NoOp(=== VoiceMail: ${CALLERID(num)} ===)
 same => n,Answer()
 same => n,VoiceMailMain(${CALLERID(num)}@${CONTEXT})
 same => n,Hangup()

; Check Status - *98
exten => *98,1,NoOp(=== Check Status ===)
 same => n,Answer()
 same => n,Playback(hello-world)
 same => n,SayDigits(${EPOCH})
 same => n,Hangup()

; ===== CHAMADAS INTERNAS (PATTERN MATCHING) =====
; Ramais: 1000-9999
exten => _XXXX,1,NoOp(=== Internal Call: ${CALLERID(num)} -> ${EXTEN} ===)
 same => n,Set(TENANT_SLUG=${CUT(CHANNEL,@,2)})
 same => n,Set(TENANT_SLUG=${CUT(TENANT_SLUG,-,2)})
 same => n,Set(CALLER=${CALLERID(num)})
 same => n,Gosub(check-permissions,s,1(${EXTEN},${CALLER},${CONTEXT}))
 same => n,GotoIf($["${PERMISSION_OK}" = "1"]?dial:denied)
 same => n(dial),Dial(PJSIP/${EXTEN}@${TENANT_SLUG},30,tTr)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy:unavail)
 same => n(busy),Busy(20)
 same => n,Hangup()
 same => n(unavail),Playback(number-not-answering)
 same => n,VoiceMail(${EXTEN}@${CONTEXT},su)
 same => n,Hangup()
 same => n(denied),Playback(access-denied)
 same => n,Hangup()

; ===== PORTAO/GATE - *500 + DDD =====
; *500 = PortAo Social
; *501 = PortAo Garagem
; *502 = PortAo Fundos
exten => _*50X,1,NoOp(=== Gate Open Request: ${CALLERID(num)} -> Gate ${EXTEN:3:1} ===)
 same => n,Set(TENANT_SLUG=${CUT(CHANNEL,@,2)})
 same => n,Set(TENANT_SLUG=${CUT(TENANT_SLUG,-,2)})
 same => n,Set(CALLER=${CALLERID(num)})
 same => n,Set(GATE_ID=${EXTEN:3:1})
 same => n,Set(GATE_NAME=${IF($["${GATE_ID}"="0"]?social:${IF($["${GATE_ID}"="1"]?garagem:fundos)})})
 same => n,Answer()
 same => n,Playback(please-hold)
 same => n,AGI(agi://backend:5000/api/agi/check-gate-permission?tenant=${TENANT_SLUG}&extension=${CALLER}&gate=${GATE_NAME})
 same => n,GotoIf($["${AGI_RESULT}"="allowed"]?open:denied)
 same => n(open),System(/usr/local/bin/open_gate.sh ${GATE_NAME})
 same => n,Playback(transaction-complete)
 same => n,Hangup()
 same => n(denied),Playback(access-denied)
 same => n,Hangup()

; ===== CHAMADAS EXTERNAS (OUTBOUND) =====
; Celular: 9XXXXXXXX (9 dAgitos)
; Fixo: XXXXXXXX (8 dAgitos)
; DDD: 0XX + XXXXXXXX
; DDI: 00XX + nAmero
exten => _9XXXXXXXX,1,NoOp(=== Outbound Call: ${CALLERID(num)} -> ${EXTEN} ===)
 same => n,Set(TENANT_SLUG=${CUT(CHANNEL,@,2)})
 same => n,Set(TENANT_SLUG=${CUT(TENANT_SLUG,-,2)})
 same => n,Set(TENANT_ID=${CURL(http://backend:5000/api/tenants/get-id-by-slug?slug=${TENANT_SLUG})})
 same => n,Set(TRUNK=${CURL(http://backend:5000/api/agi/get-outbound-route?tenantId=${TENANT_ID}&number=${EXTEN})})
 same => n,GotoIf($["${TRUNK}"="null"]?no-route:dial)
 same => n(dial),Dial(PJSIP/${EXTEN}@${TRUNK},60,tTr)
 same => n,Hangup()
 same => n(no-route),Playback(ss-noservice)
 same => n,Hangup()

; DDD
exten => _0XXXXXXXXXX,1,NoOp(=== Outbound DDD: ${CALLERID(num)} -> ${EXTEN} ===)
 same => n,Goto(9${EXTEN:1},1)

; DDI
exten => _00.!,1,NoOp(=== Outbound DDI: ${CALLERID(num)} -> ${EXTEN} ===)
 same => n,Set(TENANT_SLUG=${CUT(CHANNEL,@,2)})
 same => n,Set(TENANT_SLUG=${CUT(TENANT_SLUG,-,2)})
 same => n,Set(TENANT_ID=${CURL(http://backend:5000/api/tenants/get-id-by-slug?slug=${TENANT_SLUG})})
 same => n,Set(TRUNK=${CURL(http://backend:5000/api/agi/get-outbound-route?tenantId=${TENANT_ID}&number=${EXTEN})})
 same => n,GotoIf($["${TRUNK}"="null"]?no-route:dial)
 same => n(dial),Dial(PJSIP/${EXTEN}@${TRUNK},60,tTr)
 same => n,Hangup()
 same => n(no-route),Playback(ss-noservice)
 same => n,Hangup()

; ===== EMERGASNCIAS (SEMPRE PERMITIDO) =====
exten => 190,1,NoOp(=== Emergency: Police ===)
 same => n,Dial(PJSIP/190@trunk-emergency,30)
 same => n,Hangup()

exten => 192,1,NoOp(=== Emergency: Ambulance ===)
 same => n,Dial(PJSIP/192@trunk-emergency,30)
 same => n,Hangup()

exten => 193,1,NoOp(=== Emergency: Fire Department ===)
 same => n,Dial(PJSIP/193@trunk-emergency,30)
 same => n,Hangup()

; ============================================
; SUBROUTINE: Verificar PermissAes
; ============================================
[check-permissions]
exten => s,1,NoOp(=== Checking Permissions: ${ARG1} from ${ARG2} in ${ARG3} ===)
 same => n,Set(PERMISSION_OK=1)
 ; TODO: Implementar lAgica de permissAes via AGI/API
 ; Por enquanto sempre permite
 same => n,Return()

; ============================================
; CONTEXTOS DOS TENANTS (HERDAM tenant-base)
; ============================================
[ctx-belavista](tenant-base)

[ctx-acme](tenant-base)

[ctx-teste](tenant-base)

; ============================================
; CONTEXTO DE ENTRADA (DIDs)
; Chamadas chegam aqui e sAo roteadas
; ============================================
[from-external]
exten => _X.,1,NoOp(=== Incoming Call: ${CALLERID(num)} -> DID ${EXTEN} ===)
 same => n,Set(DID=${EXTEN})
 same => n,Set(TENANT_CONTEXT=${CURL(http://backend:5000/api/agi/get-tenant-by-did?did=${DID})})
 same => n,GotoIf($["${TENANT_CONTEXT}"="null"]?invalid:route)
 same => n(route),Goto(${TENANT_CONTEXT},s,1)
 same => n(invalid),Playback(ss-noservice)
 same => n,Hangup()

; ============================================
; CONTEXTO DEFAULT (FALLBACK)
; ============================================
[default]
exten => _X.,1,NoOp(=== Default Context: ${EXTEN} ===)
 same => n,Playback(invalid)
 same => n,Hangup()

