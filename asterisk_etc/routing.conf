; ============================================
; MAGNUS PBX - Call Routing
; Sub-rotinas para discagem interna e externa
; ============================================

; ============================================
; SUB-ROTINA: Discagem Interna
; ============================================
[dial-internal]
exten => _X.,1,NoOp(=== Internal Call: ${CALLERID(num)} -> ${EXTEN} ===)
 same => n,Set(FROM_ENDPOINT=${CHANNEL(endpoint)})
 same => n,Set(TENANT_SLUG=${CHANNEL(tenantid)})
 same => n,ExecIf($["${TENANT_SLUG}" = ""]?Set(TENANT_SLUG=${CUT(FROM_ENDPOINT,@,2)}))
 same => n,ExecIf($["${TENANT_SLUG}" = ""]?Set(TENANT_SLUG=${CUT(FROM_ENDPOINT,_,1)}))
 same => n,Set(FROM_EXTEN=${CUT(FROM_ENDPOINT,@,1)})
 same => n,ExecIf($["${FROM_ENDPOINT}" = "${FROM_EXTEN}"]?Set(FROM_EXTEN=${CUT(FROM_ENDPOINT,_,2)}))
 same => n,ExecIf($["${FROM_EXTEN}" = ""]?Set(FROM_EXTEN=${FROM_ENDPOINT}))
 same => n,Set(DEST_ENDPOINT=${EXTEN}@${TENANT_SLUG})
 same => n,ExecIf($["${FROM_ENDPOINT}" = "${CUT(FROM_ENDPOINT,@,1)}"]?Set(DEST_ENDPOINT=${TENANT_SLUG}_${EXTEN}))
 
 same => n,NoOp(TenantID=${CHANNEL(tenantid)} | Route: ${FROM_EXTEN}@${TENANT_SLUG} -> ${DEST_ENDPOINT})
 
 ; Verificar Call Forward
 same => n,Set(CF_TARGET=${DB(CF/${FROM_EXTEN})})
 same => n,GotoIf($["${CF_TARGET}" != ""]?call_forward:normal_call)
 
 same => n(call_forward),NoOp(Forwarded to ${CF_TARGET})
 same => n,Set(DEST_ENDPOINT=${CF_TARGET}@${TENANT_SLUG})
 same => n,ExecIf($["${FROM_ENDPOINT}" = "${CUT(FROM_ENDPOINT,@,1)}"]?Set(DEST_ENDPOINT=${TENANT_SLUG}_${CF_TARGET}))
 
 same => n(normal_call),Set(CALLERID(name)=${FROM_EXTEN})
 same => n,Dial(PJSIP/${DEST_ENDPOINT},30,TtKkHhXx)
 
 ; Tratamento de não atendimento
 same => n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?voicemail)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
 same => n,GotoIf($["${DIALSTATUS}" = "CHANUNAVAIL"]?unavailable)
 same => n,Hangup()
 
 same => n(voicemail),NoOp(Sending to voicemail - No Answer)
 same => n,VoiceMail(${EXTEN}@${CONTEXT},u)
 same => n,Hangup()
 
 same => n(busy),NoOp(Extension busy)
 same => n,VoiceMail(${EXTEN}@${CONTEXT},b)
 same => n,Hangup()
 
 same => n(unavailable),NoOp(Extension unavailable)
 same => n,Playback(ss-noservice)
 same => n,Hangup()

; ============================================
; SUB-ROTINA: Discagem Externa
; ============================================
[dial-outbound]
exten => _X.,1,NoOp(=== Outbound Call: ${CALLERID(num)} -> ${EXTEN} ===)
 same => n,Set(FROM_ENDPOINT=${CHANNEL(endpoint)})
 same => n,Set(TENANT_SLUG=${CHANNEL(tenantid)})
 same => n,ExecIf($["${TENANT_SLUG}" = ""]?Set(TENANT_SLUG=${CUT(FROM_ENDPOINT,@,2)}))
 same => n,ExecIf($["${TENANT_SLUG}" = ""]?Set(TENANT_SLUG=${CUT(FROM_ENDPOINT,_,1)}))
 same => n,Set(FROM_EXTEN=${CUT(FROM_ENDPOINT,@,1)})
 same => n,ExecIf($["${FROM_ENDPOINT}" = "${FROM_EXTEN}"]?Set(FROM_EXTEN=${CUT(FROM_ENDPOINT,_,2)}))
 same => n,ExecIf($["${FROM_EXTEN}" = ""]?Set(FROM_EXTEN=${FROM_ENDPOINT}))
 
 same => n,NoOp(TenantID=${CHANNEL(tenantid)} | External: ${FROM_EXTEN}@${TENANT_SLUG} -> ${EXTEN})
 
 ; Buscar rota de saída via API
 same => n,Set(API_URL=http://backend:5000/api/agi/get-outbound-route)
 same => n,Set(QUERY=?tenantId=${TENANT_SLUG}&number=${EXTEN})
 same => n,Set(RESPONSE=${CURL(${API_URL}${QUERY})})
 
 ; Parse JSON (simplificado)
 same => n,GotoIf($["${RESPONSE}" != ""]?check_trunk:no_route)
 
 same => n(check_trunk),NoOp(Looking for trunk...)
 ; TODO: Parse JSON properly - por enquanto define trunk fixo
 same => n,Set(TRUNK_NAME=trunk-provider)
 same => n,GotoIf($["${TRUNK_NAME}" != ""]?dial_trunk:no_trunk)
 
 same => n(dial_trunk),Dial(PJSIP/${EXTEN}@${TRUNK_NAME},60,TtKkHhXx)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy:unavail)
 same => n,Hangup()
 
 same => n(busy),Busy(20)
 same => n,Hangup()
 
 same => n(unavail),Playback(all-circuits-busy-now)
 same => n,Hangup()
 
 same => n(no_trunk),Answer()
 same => n,Playback(cannot-complete-as-dialed)
 same => n,Hangup()
 
 same => n(no_route),Answer()
 same => n,Playback(ss-noservice)
 same => n,Hangup()

; ============================================
; SUB-ROTINA: Números de Emergência
; ============================================
[dial-emergency]
exten => _X.,1,NoOp(=== Emergency Call: ${EXTEN} ===)
 same => n,Set(FROM_ENDPOINT=${CHANNEL(endpoint)})
 same => n,Set(TENANT_SLUG=${CHANNEL(tenantid)})
 same => n,ExecIf($["${TENANT_SLUG}" = ""]?Set(TENANT_SLUG=${CUT(FROM_ENDPOINT,@,2)}))
 same => n,ExecIf($["${TENANT_SLUG}" = ""]?Set(TENANT_SLUG=${CUT(FROM_ENDPOINT,_,1)}))
 same => n,NoOp(TenantID=${CHANNEL(tenantid)} | Emergency tenant=${TENANT_SLUG})
 
 ; Emergências sempre usam trunk prioritário
 same => n,Set(TRUNK_NAME=trunk-emergency)
 same => n,Dial(PJSIP/${EXTEN}@${TRUNK_NAME},120,TtKkHhXx)
 
 ; Fallback se trunk não existir
 same => n,Answer()
 same => n,Playback(cannot-complete-as-dialed)
 same => n,Hangup()

; ============================================
; CONTEXTO: Chamadas Recebidas (DIDs)
; ============================================
[from-trunk]
; Chamadas vindas de trunks SIP externos
exten => _X.,1,NoOp(=== Incoming DID: ${EXTEN} ===)
 same => n,Set(DID=${EXTEN})
 same => n,Set(CHANNEL(language)=pt_BR)
 
 ; Buscar roteamento do DID via API
 same => n,Set(API_URL=http://backend:5000/api/agi/get-did-route)
 same => n,Set(QUERY=?did=${DID})
 same => n,Set(RESPONSE=${CURL(${API_URL}${QUERY})})
 
 ; TODO: Parse JSON e rotear para tenant/extension correto
 ; Exemplo: Goto(ctx-belavista,1000,1)
 
 ; Temporário: IVR genérico
 same => n,Answer()
 same => n,Playback(welcome)
 same => n,Hangup()
